<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desk Booking - Real-time Availability</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .connection-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            margin-left: 10px;
        }

        .connected {
            background-color: #4CAF50;
            color: white;
        }

        .disconnected {
            background-color: #f44336;
            color: white;
        }

        .filters {
            background-color: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group label {
            margin-right: 10px;
            font-weight: bold;
            color: #555;
        }

        .filter-group select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            min-width: 150px;
        }

        .desks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .desk-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .desk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .desk-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .desk-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .status-available {
            background-color: #4CAF50;
            color: white;
        }

        .status-booked {
            background-color: #f44336;
            color: white;
        }

        .status-held {
            background-color: #FFC107;
            color: black;
        }

        .desk-details {
            margin-bottom: 15px;
        }

        .detail-item {
            margin: 5px 0;
            color: #666;
        }

        .slots-container {
            margin-top: 15px;
        }

        .slot-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .slot-time {
            color: #666;
        }

        .slot-price {
            font-weight: bold;
            color: #2196F3;
        }

        .last-update {
            text-align: center;
            color: #666;
            margin-top: 20px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Desk Booking System</h1>
            <div>
                Connection Status: 
                <span id="connectionStatus" class="connection-status disconnected">Disconnected</span>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label for="locationFilter">Location:</label>
                <select id="locationFilter" multiple>
                    <!-- Options will be dynamically loaded -->
                </select>
            </div>
            <div class="filter-group">
                <label for="deskTypeFilter">Desk Type:</label>
                <select id="deskTypeFilter" multiple>
                    <!-- Options will be dynamically loaded -->
                </select>
            </div>
            <div class="filter-group">
                <label for="slotTypeFilter">Slot Type:</label>
                <select id="slotTypeFilter" multiple>
                    <!-- Options will be dynamically loaded -->
                </select>
            </div>
            <div class="filter-group">
                <label for="bookingDateFilter">Booking Date:</label>
                <input type="date" id="bookingDateFilter">
            </div>
        </div>

        <div id="desksContainer" class="desks-grid">
            <!-- Desk cards will be dynamically inserted here -->
        </div>

        <div id="lastUpdate" class="last-update">
            Last updated: Never
        </div>
    </div>

    <script>
        const socket = io('http://localhost:5000', {
            reconnection: true,
            reconnectionAttempts: Infinity,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000,
            transports: ['websocket', 'polling']
        });
        const desksContainer = document.getElementById('desksContainer');
        const connectionStatus = document.getElementById('connectionStatus');
        const lastUpdate = document.getElementById('lastUpdate');
        const locationFilter = document.getElementById('locationFilter');
        const deskTypeFilter = document.getElementById('deskTypeFilter');
        const slotTypeFilter = document.getElementById('slotTypeFilter');
        const bookingDateFilter = document.getElementById('bookingDateFilter');

        let currentFilters = {
            location_ids: [],
            desk_type_ids: [],
            slot_type_ids: [],
            booking_date: null
        };

        // Function to get selected options from a multiple select dropdown
        function getSelectedOptions(selectElement) {
            return Array.from(selectElement.selectedOptions).map(option => option.value);
        }

        // Function to emit filter changes to the server
        function emitFilterChanges() {
            currentFilters.location_ids = getSelectedOptions(locationFilter);
            currentFilters.desk_type_ids = getSelectedOptions(deskTypeFilter);
            currentFilters.slot_type_ids = getSelectedOptions(slotTypeFilter);
            currentFilters.booking_date = bookingDateFilter.value || null; // Get date value, or null if empty
            console.log('Emitting filter change:', currentFilters);
            socket.emit('filter_update', currentFilters);
        }

        // Event listeners for filter changes
        locationFilter.addEventListener('change', emitFilterChanges);
        deskTypeFilter.addEventListener('change', emitFilterChanges);
        slotTypeFilter.addEventListener('change', emitFilterChanges);
        bookingDateFilter.addEventListener('change', emitFilterChanges);

        // Fetch master data (locations, desk types, and slot types) on page load
        async function fetchMasterData() {
            try {
                const [locationsRes, deskTypesRes, slotsRes] = await Promise.all([
                    fetch('http://localhost:5000/api/master-data/locations'),
                    fetch('http://localhost:5000/api/master-data/desk-types'),
                    fetch('http://localhost:5000/api/master-data/slots')
                ]);

                const locationsData = await locationsRes.json();
                const deskTypesData = await deskTypesRes.json();
                const slotsData = await slotsRes.json(); // Get slot types data

                // Populate location filter
                if (locationsData.locations) {
                    locationFilter.innerHTML = '<option value="">All Locations</option>'; // Add a default option
                    locationsData.locations.forEach(loc => {
                        const option = document.createElement('option');
                        option.value = loc.location_id;
                        option.textContent = loc.location_name;
                        locationFilter.appendChild(option);
                    });
                }

                // Populate desk type filter
                if (deskTypesData.desk_types) {
                    deskTypeFilter.innerHTML = '<option value="">All Desk Types</option>'; // Add a default option
                    deskTypesData.desk_types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.desk_type_id;
                        option.textContent = type.desk_type;
                        deskTypeFilter.appendChild(option);
                    });
                }

                // Populate slot type filter
                if (slotsData.slots) {
                    slotTypeFilter.innerHTML = '<option value="">All Slot Types</option>'; // Add a default option
                    slotsData.slots.forEach(slot => {
                        const option = document.createElement('option');
                        option.value = slot.slot_id;
                        option.textContent = slot.slot_type;
                        slotTypeFilter.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error fetching master data:', error);
            }
        }

        // Initial fetch of master data
        fetchMasterData();

        // Connection event handlers
        socket.on('connect', () => {
            console.log('Connected to WebSocket');
            connectionStatus.textContent = 'Connected';
            connectionStatus.className = 'connection-status connected';
            // Emit current filters on connect/reconnect to get initial data with filters applied
            emitFilterChanges();
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from WebSocket');
            connectionStatus.textContent = 'Disconnected';
            connectionStatus.className = 'connection-status disconnected';
        });

        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
            connectionStatus.textContent = 'Connection Error';
            connectionStatus.className = 'connection-status disconnected';
        });

        socket.on('reconnect_attempt', (attemptNumber) => {
            console.log('Reconnection attempt:', attemptNumber);
            connectionStatus.textContent = `Reconnecting (${attemptNumber})...`;
            connectionStatus.className = 'connection-status disconnected';
        });

        socket.on('reconnect', (attemptNumber) => {
            console.log('Reconnected after', attemptNumber, 'attempts');
            connectionStatus.textContent = 'Connected';
            connectionStatus.className = 'connection-status connected';
            emitFilterChanges(); // Re-emit filters on successful reconnection
        });

        // Handle desk updates
        socket.on('desk_update', (data) => {
            console.log('Received desk update:', data);
            if (data && data.desks) {
                updateDesksDisplay(data.desks);
                lastUpdate.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
            } else {
                console.error('Invalid desk data received:', data);
            }
        });

        function updateDesksDisplay(desks) {
            console.log('updateDesksDisplay called with', desks.length, 'desks.');
            desksContainer.innerHTML = ''; // Clear existing desks

            if (desks.length === 0) {
                desksContainer.innerHTML = '<p style="text-align: center; width: 100%; color: #888;">No desks found for the selected filters.</p>';
                console.log('No desks found, displaying message.');
                return;
            }

            desks.forEach(desk => {
                const deskCard = document.createElement('div');
                deskCard.className = 'desk-card';

                const deskHeader = document.createElement('div');
                deskHeader.className = 'desk-header';
                deskHeader.innerHTML = `
                    <span class="desk-name">${desk.desk_name}</span>
                    <span class="desk-status status-${desk.desk_status.toLowerCase()}">${desk.desk_status}</span>
                `;

                const deskDetails = document.createElement('div');
                deskDetails.className = 'desk-details';
                deskDetails.innerHTML = `
                    <div class="detail-item">Building: ${desk.building_name}</div>
                    <div class="detail-item">Floor: ${desk.floor_number}</div>
                    <div class="detail-item">Capacity: ${desk.capacity}</div>
                    <div class="detail-item">City: ${desk.city}</div>
                `;

                const slotsContainer = document.createElement('div');
                slotsContainer.className = 'slots-container';
                
                if (desk.slots && desk.slots.length > 0) {
                    desk.slots.forEach(slot => {
                        const slotItem = document.createElement('div');
                        slotItem.className = 'slot-item';
                        slotItem.innerHTML = `
                            <span class="slot-time">${slot.start_time} - ${slot.end_time}</span>
                            <span class="slot-price">$${slot.price || 'N/A'}</span>
                        `;
                        slotsContainer.appendChild(slotItem);
                    });
                } else {
                    slotsContainer.innerHTML = '<div class="detail-item">No slots available</div>';
                }

                deskCard.appendChild(deskHeader);
                deskCard.appendChild(deskDetails);
                deskCard.appendChild(slotsContainer);

                desksContainer.appendChild(deskCard);
                console.log('Appended deskCard for', desk.desk_name);
            });
            console.log('Finished updating desk display.');
        }

        // Add heartbeat to keep connection alive
        setInterval(() => {
            if (socket.connected) {
                socket.emit('ping');
            }
        }, 30000);

        // Error handling (general for WebSocket, connect_error is handled above)
        socket.on('error', (error) => {
            console.error('WebSocket error:', error);
        });
    </script>
</body>
</html> 